{# templates/payments/arrangement_form.html #}
{% extends 'payments/base4.html' %}

{% block title %}Add Payment Arrangement{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h2 class="h4 mb-0">Add New Payment Arrangement</h2>
                </div>
                <div class="card-body">
                    <form method="post" id="arrangement-form" novalidate>
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.company.id_for_label }}" class="form-label">Company *</label>
                            <select name="company" id="{{ form.company.id_for_label }}" class="form-select" required {% if form.company.value %}disabled{% endif %}>
                                <option value="">---------</option>
                                {% for company in form.fields.company.queryset %}
                                    <option value="{{ company.id }}" {% if form.company.value|stringformat:"s" == company.id|stringformat:"s" %}selected{% endif %}>
                                        {{ company.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if form.company.value %}
                                <input type="hidden" name="company" value="{{ form.company.value }}">
                            {% endif %}
                            {% if form.company.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.company.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.monthly_amount.id_for_label }}" class="form-label">Monthly Amount *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" 
                                       name="monthly_amount" 
                                       id="{{ form.monthly_amount.id_for_label }}" 
                                       class="form-control" 
                                       step="0.01" 
                                       min="0" 
                                       required 
                                       value="{{ form.monthly_amount.value|default:'' }}">
                            </div>
                            {% if form.monthly_amount.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.monthly_amount.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.number_of_months.id_for_label }}" class="form-label">Number of Months *</label>
                            <input type="number" 
                                   name="number_of_months" 
                                   id="{{ form.number_of_months.id_for_label }}" 
                                   class="form-control" 
                                   min="1" 
                                   required 
                                   value="{{ form.number_of_months.value|default:'' }}">
                            {% if form.number_of_months.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.number_of_months.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.start_date.id_for_label }}" class="form-label">Start Date *</label>
                            <input type="date" 
                                   name="start_date" 
                                   id="{{ form.start_date.id_for_label }}" 
                                   class="form-control" 
                                   required 
                                   value="{{ form.start_date.value|date:'Y-m-d'|default:'' }}">
                            {% if form.start_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.start_date.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <div class="form-check">
                                <input type="checkbox" 
                                       name="is_active" 
                                       id="{{ form.is_active.id_for_label }}" 
                                       class="form-check-input"
                                       {% if form.is_active.value %}checked{% endif %}>
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">Active</label>
                            </div>
                            {% if form.is_active.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.is_active.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div id="payment-summary" class="alert alert-info mb-4">
                            <h5>Payment Summary:</h5>
                            <p class="mb-1">Monthly Amount: $<span id="summary-monthly">0.00</span></p>
                            <p class="mb-1">Number of Months: <span id="summary-months">0</span></p>
                            <p class="mb-0">Total Amount: $<span id="summary-total">0.00</span></p>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                            <button type="submit" class="btn btn-primary me-2">Create Arrangement</button>
                            <a href="{% url 'payments:company-list' %}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const monthlyAmountInput = document.getElementById('{{ form.monthly_amount.id_for_label }}');
    const numberOfMonthsInput = document.getElementById('{{ form.number_of_months.id_for_label }}');
    const summaryMonthly = document.getElementById('summary-monthly');
    const summaryMonths = document.getElementById('summary-months');
    const summaryTotal = document.getElementById('summary-total');

    function updateSummary() {
        const monthlyAmount = parseFloat(monthlyAmountInput.value) || 0;
        const months = parseInt(numberOfMonthsInput.value) || 0;
        const total = monthlyAmount * months;

        summaryMonthly.textContent = monthlyAmount.toFixed(2);
        summaryMonths.textContent = months;
        summaryTotal.textContent = total.toFixed(2);
    }

    monthlyAmountInput.addEventListener('input', updateSummary);
    numberOfMonthsInput.addEventListener('input', updateSummary);

    // Initial update
    updateSummary();
});
</script>
{% endblock %}